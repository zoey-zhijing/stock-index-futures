# 基于市场平稳度的股指期货日内交易策略

## 主要结论：

利用改进的回撤指标能够描述市场是趋势还是震荡

多次开仓策略能够进一步提升模型表现

## 市场情绪平稳度度量

*市场情绪平稳度 = min{平均最大回撤, 平均最大反向回撤}*
![image](https://github.com/zoey-zhijing/stock-index-futures/blob/main/figures/50%E5%88%86%E9%92%9F%E5%9B%9E%E6%92%A4%E5%9B%BE.png)

![image](https://github.com/zoey-zhijing/stock-index-futures/blob/main/figures/%E5%9B%9E%E6%92%A4%E4%B8%8E%E5%8F%8D%E5%90%91%E5%9B%9E%E6%92%A4.png)

## 利用市场情绪平稳度进行交易

第一步，我们需要选择一段时间作为观察窗口，对该时间内的时间序列做分析，用于预测后续行情。因此我们首先需要在样本内优化设定时间窗口长度参数t.
第二步，通过计算市场情绪平稳度指标，判断当日是否具有开仓条件。若市场情绪平稳度指标小于阈值，则说明当日行情趋势明显，可以开仓，若情绪平稳度指标大于阈值，则说明当日行情震荡，趋势难以把握，从而放弃开仓。
第三步，判断当天趋势的方向。若t时刻股指高于股指开盘价，则预测当日趋势在市场平稳的情况下可以做多，若t时刻股指低于股指开盘价，则预测当日趋势为向下，在市场平稳的情况下可以做空。
第四步，平仓策略。若开盘之后损失超过止损阈值，则选择平仓止损，反之则一直持有仓位至收盘平仓。

## 实证结果

此处我们采用2010年4月16日至2012年12月31日的1分钟收盘价数据作为样本内进行回测，2013年1月4日至2015年1月30日的1分钟收盘价数据作为样本外进行测试，具体参数如下：

| 参数类型             | 参数取值 |
| :------------------- | -------- |
| **观察期开始时间**   | 1        |
| **观察期结束时间**   | 50       |
| **止损阈值**         | 0.5%     |
| **情绪平稳度阈值**   | 9/10000  |
| **交易成本（双边）** | 2/10000  |

### 单次开仓

**策略的复现步骤简述如下：**

1. 定义函数计算市场情绪平稳度emotional_stability，设定好相关阈值；

2. 对于每天的数据，如果情绪平稳度小于阈值，则开仓

   2.1 如果样本观察的收盘价大于样本观察开盘价，则做多，在样本观察结束的下一分钟买入；

​       2.1.1 决定是否需要止损，如果损失大于止损阈值，则平仓止损；

​       2.1.2  否则即收盘平仓，计算收益；

如果情绪平稳度大于阈值，则不开仓。

3. 对于每一天的分钟数据，重复上述操作。
![image](https://github.com/zoey-zhijing/stock-index-futures/blob/main/figures/%E5%8D%95%E6%AC%A1%E5%BC%80%E4%BB%93%E6%A8%A1%E5%9E%8B%E7%B4%AF%E8%AE%A1%E6%94%B6%E7%9B%8A.png)

![image](https://github.com/zoey-zhijing/stock-index-futures/blob/main/figures/%E5%B9%B3%E7%A8%B3%E5%BA%A6%E6%8C%87%E6%95%B0%E6%A8%A1%E5%9E%8B%E4%B8%8E%E5%9B%9E%E6%92%A4.png)

由图可以看出，**该策略累计收益可以达到250%以上，策略回撤控制在5%以内**，表现较好。

### 模型评价

| **指标**               | **样本内** | **样本外** |
| ---------------------- | ---------- | ---------- |
| **交易次数**           | 335        | 208        |
| **平均交易时间**       | 164.28     | 171.37     |
| **最大单次盈利**       | 5.65%      | 4.22%      |
| **最大单次亏损**       | -0.86%     | -0.96%     |
| **获胜次数**           | 166        | 105        |
| **失败次数**           | 169        | 103        |
| **胜率**               | 49.55%     | 50.5%      |
| **单次获胜平均收益率** | 1.15%      | 0.76%      |
| **单次失败平均亏损率** | 0.48%      | -0.46%     |
| **赔率**               | 2.40       | 1.65       |
| **最大回撤**           | -5.01%     | -4.62%     |
| **最大连胜次数**       | 5          | 4          |
| **最大连亏次数**       | 4          | 4          |
| **累计收益率**         | 172.62%    | 32.96%     |
| **年化收益率**         | 46.08%     | 15.24%     |

### 不同阈值下的开仓结果

#### 不同开仓阈值

$$
emotional\_stability\_threshold = 7/10000.0, 8/10000.0, 9 / 10000.0, 10/10000.0, 11/10000.0
$$
![image](https://github.com/zoey-zhijing/stock-index-futures/blob/main/figures/%E4%B8%8D%E5%90%8C%E5%BC%80%E4%BB%93%E9%98%88%E5%80%BC.png)

由上图可以看出，除了阈值等于7/10000时表现略差，其余阈值下模型的稳定性较好，阈值=9/10000时表现最好。

#### 不同开仓时间

$$
morning\_sample\_end = 48, 49, 50, 51, 52
$$

![image](https://github.com/zoey-zhijing/stock-index-futures/blob/main/figures/%E4%B8%8D%E5%90%8C%E5%BC%80%E4%BB%93%E6%97%B6%E9%97%B4%E6%A8%A1%E5%9E%8B%E7%B4%AF%E8%AE%A1%E6%94%B6%E7%9B%8A.png)

由图可以看出，不同开仓时间条件下模型稳定性较好。

通过上述分析，我们可以看出，市场平稳度指标可以有效区分震荡与趋势。

### 多次开仓

根据研报的分析，在上午与下午趋势相反时，上述一次开仓模型难以很好地捕捉获利机会；多次开仓的交易策略中，上午开仓同原始策略一致，观察开盘后50分钟的收盘价样本，随后决定是否开仓。但是在11：30上午收市时平仓。下午开盘则充分利用上午的数据，观察包括上午收盘数据在内11:12至13:32的数据样本，并在13:33决定下午是否开仓。

#### 模型收益与回撤
![image](https://github.com/zoey-zhijing/stock-index-futures/blob/main/figures/%E5%A4%9A%E6%AC%A1%E5%BC%80%E4%BB%93%E7%B4%AF%E8%AE%A1%E6%94%B6%E7%9B%8A.png)

![image](https://github.com/zoey-zhijing/stock-index-futures/blob/main/figures/%E5%A4%9A%E6%AC%A1%E5%BC%80%E4%BB%93%E5%9B%9E%E6%92%A4%E6%83%85%E5%86%B5.png)

#### 模型评价

| **指标**               | **样本内** | **样本外** |
| ---------------------- | ---------- | ---------- |
| **交易次数**           | 755        | 486        |
| **平均交易时间**       | 83.57      | 83.86      |
| **最大单次盈利**       | 4.56%      | 3.61%      |
| **最大单次亏损**       | -1.13%     | -1.01%     |
| **获胜次数**           | 391        | 234        |
| **失败次数**           | 364        | 252        |
| **胜率**               | 51.79%     | 48.15%     |
| **单次获胜平均收益率** | 0.69%      | 0.54%      |
| **单次失败平均亏损率** | -0.38%     | -0.37%     |
| **赔率**               | 1.82       | 1.46       |
| **最大回撤**           | -5.14%     | -6.98%     |
| **最大连胜次数**       | 5          | 5          |
| **最大连亏次数**       | 5          | 5          |
| **累计收益率**         | 209.90%    | 30.08%     |
| **年化收益率**         | 53.43%     | 13.98%     |

复现的结果表明，由于交易次数的提高，平均交易时间缩短，单次获胜的平均收益率有所下降，但是胜率有所提高，赔率有所下降。虽然最大回撤未出现研报中的改进效果，但是累计收益率和年化收益率有所提升。总的来说，改进后的模型，在样本内的应用效果要好于样本外。

![image](https://github.com/zoey-zhijing/stock-index-futures/blob/main/figures/%E5%8D%95%E6%AC%A1VS%E5%A4%9A%E6%AC%A1%E5%AF%B9%E6%AF%94.png)

对比改进前和改进后的策略累计收益曲线，我们发现，2014年以来，虽然市场的波动情况发生了改变，日内单方向趋势行情发生频率逐渐降低，可是采用多次开仓策略依然保持了累计收益率的上升趋势。

#### 不同时间开仓对比

![image](https://github.com/zoey-zhijing/stock-index-futures/blob/main/figures/%E5%A4%9A%E6%AC%A1-%E4%B8%8D%E5%90%8C%E6%97%B6%E9%97%B4.png)

![image](https://github.com/zoey-zhijing/stock-index-futures/blob/main/figures/%E5%A4%9A%E6%AC%A1%E4%B8%8B%E5%8D%88%E4%B8%8D%E5%90%8C%E6%97%B6%E9%97%B4%E5%BC%80%E4%BB%93.png)

我们比较不同参数下多次开仓策略每次开仓的收益情况，发现利用该市场平稳度指数进行交易，将上午和下午开仓的累计收益率分开来看，无论是上午还是下午的交易对于开仓时间都表现出很强的参数稳定性。具体来说，**上午开仓时间=50时表现最好，下午开仓时间=34时表现最好**。

#### 不同开仓阈值累计收益对比

![image](https://github.com/zoey-zhijing/stock-index-futures/blob/main/figures/%E4%B8%8D%E5%90%8C%E5%BC%80%E4%BB%93%E6%97%B6%E9%97%B4%E6%A8%A1%E5%9E%8B%E7%B4%AF%E8%AE%A1%E6%94%B6%E7%9B%8A.png)

由上图可以看出，对于不同开仓阈值也表现出很强的参数稳定性。**阈值=9/10000时表现最好**。

### 模型&策略总结

#### Pros：

1. 利用回撤构建因子，可以很好地抓住当日的趋势；

2. 将日内行情细化到分钟，确定了上午、下午多次开仓策略，保证了当日行情出现变化时也能及时把握交易机会。

3. 模型稳定性较好，当改变参数阈值时，模型的累计收益很稳定；

 

#### Cons:

该策略对阈值的依赖比较强；具体而言，从模型细节角度来看：

1. 我们选取50分钟的观测时间段，研报中提到50是优化选择的结果，但是未展现优化的细节，如果选择相差较大的不同时间段，则结果可能会发生较大变化。

2. 开仓方向，当前收盘价大于开盘价，则正向开仓的操作可能不够严谨；

3. 平仓时机的选择，尤其体现在多次交易的时候，选择收盘平仓可能不够严谨；
